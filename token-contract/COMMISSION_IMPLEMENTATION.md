# Реализация комиссии 6% в Jetton Wallet

## Обзор изменений

В смарт-контракт Jetton Wallet добавлена комиссия 6% с каждого перевода токенов. При отправке токенов:
- 94% суммы отправляется получателю
- 6% отправляется как комиссия на адрес jetton_master_address

## Ключевые изменения в коде

### 1. Расчет комиссии в функции `send_tokens`

```func
;; Calculate 6% commission fee
int fee = muldiv(jetton_amount, 6, 100);
int amount_to_send = jetton_amount - fee;
```

### 2. Отправка двух сообщений

Вместо одного сообщения получателю, теперь отправляется два:

1. **Сообщение получателю** (94% от суммы):
```func
;; Message to recipient (amount_to_send = 94%)
var msg_to_recipient = begin_cell()
  .store_uint(0x18, 6)
  .store_slice(to_wallet_address)
  .store_coins(0)
  .store_uint(4 + 2 + 1, 1 + 4 + 4 + 64 + 32 + 1 + 1 + 1)
  .store_ref(state_init);
```

2. **Сообщение для комиссии** (6% от суммы):
```func
;; Prepare message for fee recipient (commission 6%)
slice fee_address = jetton_master_address;
cell fee_state_init = calculate_jetton_wallet_state_init(fee_address, jetton_master_address, jetton_wallet_code);
slice fee_wallet_address = calculate_jetton_wallet_address(fee_state_init);
```

### 3. Корректировка расчета газа

Увеличен счетчик сообщений для учета дополнительного сообщения комиссии:

```func
;; Adjust message count for fee calculation
int fwd_count = forward_ton_amount ? 3 : 2;  ;; Increased to account for additional fee message
```

## Безопасность

- Используется режим отправки `64` (revert on errors) для обеих транзакций
- Проверка баланса происходит до отправки сообщений
- При ошибке в любом из сообщений вся транзакция откатывается

## Получатель комиссии

Комиссия отправляется на `jetton_master_address` - адрес мастер-контракта токена. Это обеспечивает:
- Централизованный сбор комиссий
- Возможность управления комиссиями через мастер-контракт
- Прозрачность для пользователей

## Файлы проекта

### Основные файлы:
- `contracts/jetton-wallet.fc` - оригинальный файл с комиссией (уже реализован)
- `token-contract/ft/jetton-wallet.fc` - новый файл для компиляции через Blueprint

### Зависимости:
- `token-contract/ft/op-codes.fc` - операционные коды
- `token-contract/ft/jetton-utils.fc` - утилиты для работы с jetton
- `token-contract/ft/params.fc` - параметры
- `stdlib.fc` - стандартная библиотека

## Компиляция

Для компиляции контракта необходимо:

1. Установить TON инструменты (func, fift)
2. Запустить компиляцию:

```bash
cd token-contract/ft
bash compile.sh
```

Или через Blueprint (если настроен):
```bash
npm run build
```

## Тестирование

Перед деплоем рекомендуется:

1. Протестировать в тестовой сети TON
2. Проверить корректность удержания комиссии
3. Убедиться в правильности отправки на адрес комиссии
4. Проверить обработку ошибок

## Важные замечания

⚠️ **Внимание**: 
- Комиссия удерживается с каждого перевода токенов
- Пользователи должны быть уведомлены о комиссии 6%
- Необходимо достаточно TON для оплаты газа за два сообщения
- Рекомендуется аудит кода перед продакшн деплоем

## Возможные улучшения

1. **Настраиваемая комиссия**: Добавить возможность изменения процента комиссии
2. **Отдельный адрес комиссии**: Использовать специальный адрес вместо jetton_master_address
3. **Исключения**: Добавить возможность исключения определенных адресов от комиссии
4. **Лимиты**: Установить минимальную/максимальную сумму комиссии 