# Лотерея и комиссия в Jetton Wallet

## Обзор функций

Смарт-контракт теперь включает:
1. **Комиссия 6%** с каждого перевода
2. **Лотерея 1/66** с бонусом +2%
3. **Уведомления** победителям
4. **Фиксированный адрес** для сбора комиссий

## Адрес комиссии

```
UQ_YOUR_COMMISSION_ADDRESS_HERE
```

Этот адрес используется для:
- Сбора всех комиссий (6%)
- Минта токенов при деплое
- Источника бонусов лотереи

**Важно**: Замените этот адрес на свой перед деплоем!

## Логика работы

### Обычный перевод (65/66 случаев)
```
Исходная сумма: 1000 токенов
├── Комиссия (6%): 60 токенов → адрес комиссии
└── Получателю (94%): 940 токенов
```

### Выигрыш в лотерее (1/66 случаев)
```
Исходная сумма: 1000 токенов
├── Комиссия (6%): 60 токенов → адрес комиссии
├── Получателю (94%): 940 токенов
└── Бонус лотереи (+2% от 940): +18.8 токенов
    Итого получателю: 958.8 токенов
```

## Технические детали

### Генератор случайных чисел
```func
int random_lottery() inline {
  randomize_lt();
  return rand(66) == 0; ;; 1/66 chance to win
}
```

### Расчет бонуса
```func
if (is_lottery_winner) {
  lottery_bonus = muldiv(amount_to_send, 2, 100); ;; +2% bonus
  amount_to_send += lottery_bonus;
}
```

### Уведомление победителю
```func
() send_lottery_notification(slice winner_address, int bonus_amount, int query_id) impure {
  ;; Отправляет уведомление с информацией о выигрыше
}
```

## Безопасность

### Проверки баланса
- Проверка достаточности средств до операции
- Корректировка баланса с учетом бонуса
- Откат транзакции при ошибках

### Режимы отправки
- `mode 64`: revert on errors для основных переводов
- `mode 1`: ignore errors для уведомлений

### Расчет газа
```func
int fwd_count = forward_ton_amount ? 3 : 2;
if (is_lottery_winner) {
  fwd_count += 1; ;; Дополнительное сообщение для уведомления
}
```

## Статистика лотереи

- **Шанс выигрыша**: 1/66 ≈ 1.515%
- **Частота**: примерно 1 выигрыш на 66 переводов
- **Бонус**: +2% к сумме после комиссии
- **Источник бонуса**: резерв на адресе комиссии

## Примеры использования

### Пример 1: Обычный перевод
```
Отправка: 10,000 токенов
Комиссия: 600 токенов (6%)
Получено: 9,400 токенов (94%)
Лотерея: не выиграл
```

### Пример 2: Выигрыш в лотерее
```
Отправка: 10,000 токенов
Комиссия: 600 токенов (6%)
Базовая сумма: 9,400 токенов (94%)
Бонус лотереи: +188 токенов (+2% от 9,400)
Получено: 9,588 токенов (95.88%)
Уведомление: "Lottery win! +2% bonus"
```

## Мониторинг

Для отслеживания работы лотереи можно мониторить:
1. Транзакции на адрес комиссии
2. Уведомления о выигрышах
3. Статистику выигрышей vs общее количество переводов

## Обновления кода

### Основные изменения в `send_tokens`:
1. Добавлен фиксированный адрес комиссии
2. Реализован генератор случайных чисел
3. Добавлен расчет и начисление бонуса
4. Реализована отправка уведомлений
5. Скорректирован расчет газа

### Новые функции:
- `commission_address()` - возвращает фиксированный адрес
- `random_lottery()` - генератор случайных чисел
- `send_lottery_notification()` - отправка уведомлений 